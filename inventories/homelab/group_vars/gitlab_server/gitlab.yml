---
service: gitlab
gitlab_prometheus_auth_user: "prometheus"
gitlab_prometheus_auth_password: "{{ lookup('community.hashi_vault.vault_kv2_get', 'ansible/gitlab')['secret']['prometheus_password'] }}"
gitlab:
  version: 18.5.0-ce.0
  url: https://gitlab.0lzi.com
  port: 80
  ssh_port: 2222
  prometheus: true
  registry: true
  registry_port: 5000
  registry_url: https://registry.gitlab.0lzi.com
  smtp:
    user: "{{ lookup('community.hashi_vault.vault_kv2_get', 'ansible/gitlab')['secret']['smtp_user'] }}"
    password: "{{ lookup('community.hashi_vault.vault_kv2_get', 'ansible/gitlab')['secret']['smtp_password'] }}"
    url: "smtp.gmail.com"
    port: 587
  traefik_labels:
    # GitLab main interface
    traefik/http/routers/gitlab/rule: "Host(`gitlab.0lzi.com`)"
    traefik/http/routers/gitlab/service: "gitlab"
    traefik/http/routers/gitlab/entrypoints: "websecure"
    traefik/http/routers/gitlab/tls/certresolver: "cloudflare"
    traefik/http/routers/gitlab/tls/domains/0/sans/0: "gitlab.0lzi.com"
    traefik/http/routers/gitlab/tls: "true"
    traefik/http/services/gitlab/loadbalancer/servers/0/url: "http://gitlab.0lzi.internal"
    # GitLa/ reg/stry
    traefik/http/routers/gitlab_registry/rule: "Host(`registry.gitlab.0lzi.com`)"
    traefik/http/routers/gitlab_registry/service: "gitlab_registry"
    traefik/http/routers/gitlab_registry/entrypoints: "websecure"
    traefik/http/routers/gitlab_registry/tls/certresolver: "cloudflare"
    traefik/http/services/gitlab_registry/loadbalancer/servers/0/url: "http://registry.0lzi.internal:5000"
    # GitLa/ Pro/etheus metrics endpoint
    traefik/http/routers/gitlab_prometheus/rule: "Host(`gitlab.0lzi.com`) && PathPrefix(`/metrics`)"
    traefik/http/routers/gitlab_prometheus/service: "gitlab_prometheus"
    traefik/http/routers/gitlab_prometheus/entrypoints: "websecure"
    traefik/http/routers/gitlab_prometheus/tls/certresolver: "cloudflare"
    traefik/http/services/gitlab_prometheus/loadbalancer/servers/0/url: "http://gitlab.0lzi.internal"
    traefik/http/routers/gitlab_prometheus/middlewares: "prometheus-auth"
    traefik/http/middlewares/prometheus-auth/basicauth/users: "{{ gitlab_prometheus_auth_user }}:{{ gitlab_prometheus_auth_password }}"
    traefik/http/middlewares/prometheus-auth/basicauth/realm: "gitlab"
    # Gitlab ssh_port
    traefik/tcp/routers/gitlab_ssh/rule: "HostSNI(`*`)"
    traefik/tcp/routers/gitlab_ssh/service: "gitlab_ssh"
    traefik/tcp/routers/gitlab_ssh/tls/passthrough: "true"
    traefik/tcp/routers/gitlab_ssh/entrypoints: "ssh"
    traefik/tcp/services/gitlab_ssh/loadbalancer/servers/0/address: "gitlab.0lzi.internal:2222"
