---
unseal:
  extends: .default
  stage: playbooks
  tags:
    - ansible
  when: manual
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: never   # Do NOT show in MR
    - when: manual  # Show for normal pipelines
  variables:
    VAULT_ADDR: https://vault.0lzi.com
  id_tokens:
    VAULT_ID_TOKEN:
      aud: https://vault.0lzi.com
  script:
    - uv run ansible-playbook playbooks/openbao/unseal.yml --tags node1,node2,node3
  after_script:
    - rm -rf ~/.ssh
    - rm -f vault_password
  cache:
    paths:
      - .pip_cache
      - ~/.ansible/roles
